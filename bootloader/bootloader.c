/*
 * bootloader.c
 *
 * Created: 17/02/2014 12:06:24
 *  Author: Gareth
 */ 

#include <avr/interrupt.h>
#include <avr/boot.h>
#include <avr/io.h>
#include <stdint.h>

uint8_t binary_to_load[] = {    // Arbitrary binary payload, this will be replaced later with a runtime SD card read
    0x0c, 0x94, 0x34, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00,
    0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00,
    0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00,
    0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00,
    0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00,
    0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00,
    0x0c, 0x94, 0x3e, 0x00, 0x0c, 0x94, 0x3e, 0x00, 0x11, 0x24, 0x1f, 0xbe, 0xcf, 0xef, 0xd8, 0xe0,
    0xde, 0xbf, 0xcd, 0xbf, 0x0e, 0x94, 0x40, 0x00, 0x0c, 0x94, 0x4c, 0x00, 0x0c, 0x94, 0x00, 0x00,
    0x25, 0x9a, 0x1d, 0x9a, 0x2f, 0xef, 0x89, 0xe6, 0x98, 0xe1, 0x21, 0x50, 0x80, 0x40, 0x90, 0x40,
    0xe1, 0xf7, 0x00, 0xc0, 0x00, 0x00, 0xf5, 0xcf, 0xf8, 0x94, 0xff, 0xcf
};

int main(void){
    for (int pagePtr = 0; pagePtr <= sizeof(binary_to_load); pagePtr+=SPM_PAGESIZE){     // Access the payload in 128-byte pages
        
        uint8_t sreg = SREG;    // Save SREG and disable interrupts to meet unlock restrictions
        cli();                  // (timed writes to unlock registers)
        
        boot_page_erase(pagePtr);  // Clear the page and make ready to write
        boot_spm_busy_wait();
        for (int currbyte = 0; currbyte < SPM_PAGESIZE; currbyte += 2){ // inc +2 as filling write buffer in words
            // Construct the word to put into the buffer
            uint16_t wordbuff = (binary_to_load[pagePtr + currbyte + 1] << 8) | (binary_to_load[pagePtr + currbyte]);
            boot_page_fill_safe(pagePtr+currbyte, wordbuff);
        }
        // write buffer to flash
        boot_page_write_safe(pagePtr);
        boot_rww_enable_safe();  // enable reading from flash, else the avr will just read all 0xff in flash on boot
        
        SREG = sreg;
    }
    asm("jmp 0x0000");  // run application
}